<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Widget - Interactive Playground</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            primary: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95',
              950: '#2e1065',
            }
          }
        }
      }
    }
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Custom Utilities */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Config Panel Scrollbar */
    .config-panel::-webkit-scrollbar {
      width: 6px;
    }
    .config-panel::-webkit-scrollbar-track {
      background: transparent;
    }
    .config-panel::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }

    .preview-content {
      position: relative; /* Context for absolute positioning of widget if needed */
    }

    /* Comments sidebar styles */
    #commentsSidebar {
      transition: transform 0.3s ease-in-out;
    }
    
    #commentsSidebar:not(:empty) {
      transform: translateX(0);
    }
    
    #commentsSidebar:empty {
      transform: translateX(100%);
    }

    /* Line clamp for comment text */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Custom Form Components */
    .custom-input {
      appearance: none;
      background-color: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #1e293b;
      outline: none;
      transition: all 0.2s;
      width: 100%;
    }
    .custom-input:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .custom-select {
      appearance: none;
      background-color: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: #1e293b;
      outline: none;
      transition: all 0.2s;
      width: 100%;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      cursor: pointer;
    }
    .custom-select:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .custom-checkbox {
      appearance: none;
      background-color: #fff;
      margin: 0;
      font: inherit;
      color: currentColor;
      width: 1.25em;
      height: 1.25em;
      border: 1px solid #cbd5e1;
      border-radius: 0.35em;
      display: grid;
      place-content: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .custom-checkbox::before {
      content: "";
      width: 0.65em;
      height: 0.65em;
      transform: scale(0);
      transition: 120ms transform ease-in-out;
      box-shadow: inset 1em 1em white;
      transform-origin: center;
      clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }
    .custom-checkbox:checked {
      background-color: #8b5cf6;
      border-color: #8b5cf6;
    }
    .custom-checkbox:checked::before {
      transform: scale(1);
    }

    .custom-radio {
      appearance: none;
      background-color: #fff;
      margin: 0;
      font: inherit;
      color: currentColor;
      width: 1.25em;
      height: 1.25em;
      border: 1px solid #cbd5e1;
      border-radius: 50%;
      display: grid;
      place-content: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .custom-radio::before {
      content: "";
      width: 0.65em;
      height: 0.65em;
      border-radius: 50%;
      transform: scale(0);
      transition: 120ms transform ease-in-out;
      box-shadow: inset 1em 1em #8b5cf6;
    }
    .custom-radio:checked {
      border-color: #8b5cf6;
    }
    .custom-radio:checked::before {
      transform: scale(1);
    }
  </style>
</head>
<body class="font-sans text-slate-900 bg-slate-50 selection:bg-primary-200 selection:text-primary-900 h-screen overflow-hidden flex flex-col">

  <!-- Navigation -->
  <nav class="shrink-0 w-full z-40 glass transition-all duration-300">
    <div class="px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-2">
          <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
            <div class="p-2 rounded-lg text-white shadow-lg" style="background: linear-gradient(135deg, #6366f1 0%, #9333ea 100%);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-plus w-5 h-5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="9" x2="15" y1="10" y2="10"/><line x1="12" x2="12" y1="7" y2="13"/></svg>
            </div>
            <span class="font-bold text-xl tracking-tight">CommentWidget</span>
          </a>
          <span class="ml-2 px-2 py-0.5 rounded-full bg-slate-100 text-xs font-medium text-slate-500 border border-slate-200">Playground</span>
        </div>
        <div class="hidden md:flex items-center gap-8">
          <a href="index.html" class="text-sm font-medium text-slate-600 hover:text-primary-600 transition-colors">Home</a>
          <a href="docs.html" class="text-sm font-medium text-slate-600 hover:text-primary-600 transition-colors">Docs</a>
          <a href="https://github.com/yourorg/comment-widget" target="_blank" class="flex items-center gap-2 text-slate-500 hover:text-slate-900 transition-colors">
            <i data-lucide="github" class="w-5 h-5"></i>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden">
    
    <!-- Config Panel -->
    <aside class="w-72 bg-white border-r border-slate-200 overflow-y-auto config-panel z-30 shadow-sm flex flex-col">
      <div class="p-4 pl-8 space-y-6">
        <div>
          <h2 class="text-xs font-bold text-slate-900 uppercase tracking-wider mb-3">Appearance</h2>
          <div class="space-y-3">
            <div>
              <label for="primaryColor" class="block text-sm font-medium text-slate-700 mb-1">Primary Color</label>
              <div class="flex items-center gap-2">
                <input type="color" id="primaryColor" value="#7c3aed" class="h-7 w-7 rounded cursor-pointer border-0 p-0">
                <span class="text-xs font-mono text-slate-500" id="colorValue">#7c3aed</span>
              </div>
            </div>
            <div>
              <label for="position" class="block text-sm font-medium text-slate-700 mb-1">Button Position</label>
              <select id="position" class="custom-select">
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="top-right">Top Right</option>
                <option value="top-left">Top Left</option>
              </select>
            </div>
          </div>
        </div>

        <hr class="border-slate-100 my-4">

        <div>
          <h2 class="text-xs font-bold text-slate-900 uppercase tracking-wider mb-3">Storage</h2>
          <div class="space-y-2">
            <div class="flex items-center">
              <input id="storage-local" name="storage" type="radio" value="local" checked class="custom-radio">
              <label for="storage-local" class="ml-2 block text-sm font-medium text-slate-700">LocalStorage</label>
            </div>
            <div class="flex items-center">
              <input id="storage-api" name="storage" type="radio" value="api" class="custom-radio">
              <label for="storage-api" class="ml-2 block text-sm font-medium text-slate-700">REST API</label>
            </div>
            <div class="flex items-center">
              <input id="storage-firebase" name="storage" type="radio" value="firebase" class="custom-radio">
              <label for="storage-firebase" class="ml-2 block text-sm font-medium text-slate-700">Firebase</label>
            </div>
            
            <div class="mt-4">
              <label for="storageKey" class="block text-sm font-medium text-slate-700 mb-1">Storage Key</label>
              <input type="text" id="storageKey" value="playground-comments" class="custom-input">
            </div>
          </div>
        </div>

        <hr class="border-slate-100 my-4">

        <div>
          <h2 class="text-xs font-bold text-slate-900 uppercase tracking-wider mb-3">Keyboard</h2>
          <div class="space-y-3">
            <div class="flex items-start">
              <div class="flex items-center h-4">
                <input id="enableShortcuts" type="checkbox" checked class="custom-checkbox">
              </div>
              <div class="ml-2 text-sm">
                <label for="enableShortcuts" class="font-medium text-slate-700 text-sm">Enable Shortcuts</label>
                <p class="text-slate-500 text-xs">Press key to toggle comments</p>
              </div>
            </div>
            <div>
              <label for="shortcutKey" class="block text-sm font-medium text-slate-700 mb-1">Toggle Key</label>
              <input type="text" id="shortcutKey" value="c" maxlength="1" class="custom-input w-12 text-center uppercase font-mono p-1">
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-auto p-4 pl-8 bg-slate-50 border-t border-slate-200">
        <h2 class="text-xs font-bold text-slate-900 uppercase tracking-wider mb-3">Export Config</h2>
        <div class="relative">
          <pre id="generatedCode" class="bg-slate-900 text-slate-300 p-2 rounded-lg text-xs font-mono overflow-x-auto whitespace-pre-wrap max-h-32"></pre>
          <button onclick="copyCode()" class="copy-btn absolute top-1.5 right-1.5 bg-slate-700 hover:bg-slate-600 text-white p-1 rounded transition-colors" title="Copy to clipboard">
            <i data-lucide="copy" class="w-3 h-3"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Preview Area -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50 relative overflow-hidden">
      
      <div class="bg-white border-b border-slate-200 px-4 py-2 flex items-center justify-between shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-2 text-sm text-slate-600">
          <span class="flex h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
          Live Preview
        </div>
        <div class="flex items-center gap-4">

          <div class="text-xs text-slate-400 font-mono">
            Press '<span id="keyDisplay" class="uppercase font-bold text-slate-600">C</span>' to comment
          </div>
        </div>
      </div>
      
      <!-- Content Wrapper -->
      <div class="flex-1 flex overflow-hidden relative">
        <!-- Content -->
        <div class="flex-1 overflow-y-auto preview-content p-8 md:p-12 relative transition-all duration-300 ease-in-out">
          <div id="content-card" class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 p-8 md:p-12 min-h-[1200px] relative">
          
          <div class="mb-12">
            <span class="inline-block px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 text-xs font-bold tracking-wide uppercase mb-4">Design System</span>
            <h1 class="text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">Product Components</h1>
            <p class="text-lg text-slate-600 leading-relaxed">
              This is a live playground. Use the widget to leave comments on any element below. 
              The container height is synced automatically.
            </p>
          </div>

          <!-- Buttons -->
          <section class="mb-16">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">Buttons</h3>
            <div class="flex flex-wrap gap-4">
              <button class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-sm transition-colors interactive">
                Primary Action
              </button>
              <button class="px-5 py-2.5 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium rounded-lg shadow-sm transition-colors interactive">
                Secondary Action
              </button>
              <button class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-sm transition-colors interactive">
                Danger Zone
              </button>
            </div>
          </section>

          <!-- Typography -->
          <section class="mb-16">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">Typography Scale</h3>
            <div class="space-y-6 border-l-2 border-slate-100 pl-6">
              <div>
                <span class="text-xs text-slate-400 font-mono mb-1 block">Display 2xl</span>
                <div class="text-5xl font-extrabold text-slate-900">The quick brown fox</div>
              </div>
              <div>
                <span class="text-xs text-slate-400 font-mono mb-1 block">Heading xl</span>
                <div class="text-3xl font-bold text-slate-900">Jumps over the lazy dog</div>
              </div>
              <div>
                <span class="text-xs text-slate-400 font-mono mb-1 block">Body Base</span>
                <div class="text-base text-slate-600">
                  Typography is the art and technique of arranging type to make written language legible, readable, and appealing when displayed.
                </div>
              </div>
            </div>
          </section>

          <!-- Cards Grid -->
          <section class="mb-16">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">Card Components</h3>
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Card 1 -->
              <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg transition-shadow interactive">
                <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center mb-4">
                  <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                </div>
                <h4 class="text-lg font-bold text-slate-900 mb-2">Analytics</h4>
                <p class="text-slate-600 text-sm">Real-time data processing and visualization for your team.</p>
              </div>

              <!-- Card 2 -->
              <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg transition-shadow interactive">
                <div class="w-12 h-12 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center mb-4">
                  <i data-lucide="users" class="w-6 h-6"></i>
                </div>
                <h4 class="text-lg font-bold text-slate-900 mb-2">Team Management</h4>
                <p class="text-slate-600 text-sm">Collaborate with your team members in a secure environment.</p>
              </div>
            </div>
          </section>

          <!-- Forms -->
          <section class="mb-16">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">Form Elements</h3>
            <div class="max-w-md space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                <input type="email" class="custom-input interactive" placeholder="you@example.com">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Role</label>
                <select class="custom-select interactive">
                  <option>Developer</option>
                  <option>Designer</option>
                  <option>Product Manager</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="terms" class="custom-checkbox interactive">
                <label for="terms" class="text-sm text-slate-600">I accept the terms and conditions</label>
              </div>
            </div>
          </section>

          <div class="h-32"></div> <!-- Spacer -->
          
        </div>
      </div>

      <!-- Sidebar -->
      <div id="commentsSidebar" class="border-l border-slate-200 bg-white transition-all duration-300 ease-in-out w-0 overflow-hidden shrink-0 z-40">
         <!-- Sidebar Content -->
      </div>
    </div>
  </main>
  </div>

  <script type="module">
    import { initCommentWidget, LocalStorageAdapter, APIAdapter, FirebaseAdapter, SupabaseAdapter } from './src/index.ts';

    // Mock the namespace used in the code
    const CommentWidget = {
      init: initCommentWidget,
      LocalStorageAdapter,
      APIAdapter,
      FirebaseAdapter,
      SupabaseAdapter
    };

    let widgetInstance = null;

    function initWidget() {
      // Destroy existing widget if any
      if (widgetInstance) {
        widgetInstance.destroy();
      }

      // Get configuration values
      const primaryColor = document.getElementById('primaryColor').value;
      const position = document.getElementById('position').value;
      const storageType = document.querySelector('input[name="storage"]:checked').value;
      const storageKey = document.getElementById('storageKey').value || 'playground-comments';
      const enableShortcuts = document.getElementById('enableShortcuts').checked;
      const shortcutKey = (document.getElementById('shortcutKey').value || 'c').toLowerCase();

      // Update Color Value Display
      document.getElementById('colorValue').textContent = primaryColor;
      
      // Update Key Display
      document.getElementById('keyDisplay').textContent = shortcutKey;

      // Create storage adapter based on selection
      let storage;
      switch(storageType) {
        case 'local':
          storage = new CommentWidget.LocalStorageAdapter(storageKey);
          break;
        case 'api':
          storage = new CommentWidget.APIAdapter({
            baseUrl: 'https://your-api.com',
            endpoints: { load: '/comments', save: '/comments' }
          });
          break;
        case 'firebase':
        case 'supabase':
          storage = new CommentWidget.LocalStorageAdapter(storageKey + '-' + storageType);
          break;
        default:
          storage = new CommentWidget.LocalStorageAdapter(storageKey);
      }

      const container = document.getElementById('content-card');
      if (!container) {
        console.warn('Comment Widget: Content card container not found, falling back to body');
      }

      // Initialize widget
      widgetInstance = CommentWidget.init({
        storage: storage,
        primaryColor: primaryColor,
        position: position,
        enableKeyboardShortcuts: enableShortcuts,
        keyboardShortcut: shortcutKey,
        container: container || document.body // Fallback explicit
      });

      // Store storage instance for sidebar access
      window.currentStorage = storage;
      window.widgetInstance = widgetInstance;

      // Update generated code
      updateGeneratedCode();
    }

    function updateGeneratedCode() {
      const primaryColor = document.getElementById('primaryColor').value;
      const position = document.getElementById('position').value;
      const storageType = document.querySelector('input[name="storage"]:checked').value;
      const storageKey = document.getElementById('storageKey').value || 'my-comments';
      const enableShortcuts = document.getElementById('enableShortcuts').checked;
      const shortcutKey = (document.getElementById('shortcutKey').value || 'c').toLowerCase();

      let storageCode = '';
      switch(storageType) {
        case 'local':
          storageCode = `new LocalStorageAdapter('${storageKey}')`;
          break;
        case 'api':
          storageCode = `new APIAdapter({
  baseUrl: 'https://your-api.com',
  headers: { 'Authorization': 'Bearer YOUR_TOKEN' }
})`;
          break;
        case 'firebase':
          storageCode = `new FirebaseAdapter(db, '${storageKey}')`;
          break;
        case 'supabase':
          storageCode = `new SupabaseAdapter(supabase, '${storageKey}')`;
          break;
      }

      const code = `import { initCommentWidget, ${storageType === 'local' ? 'LocalStorageAdapter' : storageType === 'api' ? 'APIAdapter' : storageType === 'firebase' ? 'FirebaseAdapter' : 'SupabaseAdapter'} } from '@commentwidget/core';

const widget = initCommentWidget({
  storage: ${storageCode},
  primaryColor: '${primaryColor}',
  position: '${position}',
  enableKeyboardShortcuts: ${enableShortcuts},
  keyboardShortcut: '${shortcutKey}'
});`;

      document.getElementById('generatedCode').textContent = code;
    }

    // Expose to window for onclick handlers
    window.copyCode = function() {
      const code = document.getElementById('generatedCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.classList.add('bg-green-600', 'text-white');
        const icon = btn.querySelector('i');
        // Simple visual feedback
        setTimeout(() => {
          btn.classList.remove('bg-green-600', 'text-white');
        }, 2000);
      });
    }

    // Add event listeners to all config inputs
    document.getElementById('primaryColor').addEventListener('input', initWidget);
    document.getElementById('position').addEventListener('change', initWidget);
    document.querySelectorAll('input[name="storage"]').forEach(radio => {
      radio.addEventListener('change', initWidget);
    });
    document.getElementById('storageKey').addEventListener('input', initWidget);
    document.getElementById('enableShortcuts').addEventListener('change', initWidget);
    document.getElementById('shortcutKey').addEventListener('input', initWidget);

    // Expose functions to window for HTML event handlers
    window.toggleCommentsSidebar = toggleCommentsSidebar;
    window.filterComments = filterComments;
    window.sortComments = sortComments;
    window.navigateToComment = navigateToComment;
    
    // Initialize widget on load
    window.addEventListener('load', () => {
      // Ensure DOM is ready
      initWidget();
    });
    
    lucide.createIcons();

    // Comments Sidebar functionality
    // (Managed by event listeners below)

    function renderCommentsSidebar() {
      const sidebar = document.getElementById('commentsSidebar');
      
      // Get comments from widget
      let comments = [];
      if (window.widgetInstance && window.widgetInstance.getAllComments) {
        comments = window.widgetInstance.getAllComments();
      }
      
      // Apply filters
      let filteredComments = comments;
      if (currentFilter === 'resolved') {
        filteredComments = comments.filter(c => c.resolved);
      } else if (currentFilter === 'unresolved') {
        filteredComments = comments.filter(c => !c.resolved);
      }
      
      // Apply sorting
      filteredComments = sortCommentsArray(filteredComments, currentSort);
      
      sidebar.innerHTML = `
        <div class="bg-white border-l border-slate-200 flex flex-col h-full shadow-lg" style="width: 320px;">
          <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-white">
            <div class="flex items-center gap-2">
              <h2 class="font-semibold text-black text-sm">Comments</h2>
              <span class="text-white text-xs px-2 py-0.5 rounded-full font-medium" style="background-color: ${document.getElementById('primaryColor').value}">
                ${filteredComments.length}
              </span>
            </div>
            <button onclick="toggleCommentsSidebar()" class="p-1.5 hover:bg-slate-100 rounded-lg transition-colors">
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <div class="p-4 border-b border-slate-200 bg-white">
            <div class="flex gap-2 items-center justify-between">
              <div class="flex gap-1">
                ${['all', 'unresolved', 'resolved'].map(status => `
                  <button
                    onclick="filterComments('${status}')"
                    class="px-2 py-1 text-xs font-medium rounded-full transition-colors ${getFilterButtonClass(status, currentFilter)}"
                    style="${getFilterButtonStyle(status, currentFilter)}"
                  >
                    ${status === 'all' ? 'All' : status === 'resolved' ? 'Resolved' : 'Open'}
                  </button>
                `).join('')}
              </div>
              
              <select onchange="sortComments(this.value)" class="custom-select text-xs !py-1 !pl-3 !pr-8 !h-8 bg-slate-50 border-slate-200">
                <option value="page" ${currentSort === 'page' ? 'selected' : ''}>By Page</option>
                <option value="author" ${currentSort === 'author' ? 'selected' : ''}>By Author</option>
                <option value="date" ${currentSort === 'date' ? 'selected' : ''}>By Date</option>
              </select>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto bg-white">
            ${filteredComments.length === 0 ? `
              <div class="p-8 text-center text-slate-500">
                <svg class="w-12 h-12 mx-auto opacity-30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-sm">No comments found</p>
              </div>
            ` : `
              <div class="space-y-0">
                ${filteredComments.map(comment => `
                  <div
                    onclick="navigateToComment('${comment.id}')"
                    class="p-3 hover:bg-slate-50 border-b border-slate-100 cursor-pointer transition-colors"
                  >
                    <div class="flex items-start gap-2">
                      <div class="w-2 h-2 rounded-full mt-2 shrink-0" style="background-color: ${comment.resolved ? '#10b981' : document.getElementById('primaryColor').value}"></div>
                      
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-slate-900 line-clamp-2 mb-1 leading-relaxed">
                          ${comment.text}
                        </p>
                        
                        <div class="flex items-center flex-wrap gap-2 text-xs text-slate-500">
                          <div class="flex items-center gap-1">
                            <div class="w-4 h-4 rounded-full flex items-center justify-center" style="background-color: ${document.getElementById('primaryColor').value}1A">
                              <span class="text-[10px] font-semibold" style="color: ${document.getElementById('primaryColor').value}">
                                ${comment.author.charAt(0).toUpperCase()}
                              </span>
                            </div>
                            <span class="font-medium">${comment.author}</span>
                          </div>
                          
                          <div class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>${new Date(comment.timestamp).toLocaleDateString()}</span>
                          </div>

                          ${comment.replies.length > 0 ? `
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                              </svg>
                              <span>${comment.replies.length}</span>
                            </div>
                          ` : ''}

                          ${comment.resolved ? `
                            <div class="flex items-center gap-1" style="color: #10b981">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                              </svg>
                              <span class="font-medium">Resolved</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>

                      <svg class="w-4 h-4 text-slate-400 shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
      
      // Update comments count
      updateCommentsCount();
    }

    function sortCommentsArray(comments, sortBy) {
      const sorted = [...comments];
      switch (sortBy) {
        case 'author':
          return sorted.sort((a, b) => (a.author || 'Anonymous').localeCompare(b.author || 'Anonymous'));
        case 'date':
          return sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        case 'page':
        default:
          return sorted.sort((a, b) => (a.pageUrl || '/').localeCompare(b.pageUrl || '/'));
      }
    }

    function updateCommentsCount() {
      const comments = window.widgetInstance && window.widgetInstance.getAllComments ? window.widgetInstance.getAllComments() : [];
      const countEl = document.getElementById('commentsCount');
      if (countEl) countEl.textContent = comments.length;
    }

    function filterComments(filter) {
      currentFilter = filter;
      renderCommentsSidebar();
    }

    function sortComments(sortBy) {
      currentSort = sortBy;
      renderCommentsSidebar();
    }

    function navigateToComment(commentId) {
      if (window.widgetInstance) {
        // Use the widget's navigateToComment method
        window.widgetInstance.navigateToComment(commentId);
        // Sidebar stays open to show context
      }
    }

    // Global variables for sidebar state
    let currentFilter = 'all';
    let currentSort = 'page';

    function getFilterButtonClass(status, current) {
      return status === current ? 'text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200';
    }

    function getFilterButtonStyle(status, current) {
      return status === current ? `background-color: ${document.getElementById('primaryColor').value}` : '';
    }

    // Sync sidebar with widget state
    window.addEventListener('comment-widget-state-change', (e) => {
      const isVisible = e.detail.isVisible;
      const sidebar = document.getElementById('commentsSidebar');
      const button = document.getElementById('toggleCommentsSidebar');
      
      if (isVisible) {
        // Open sidebar
        sidebar.style.width = '320px';
        renderCommentsSidebar();
        if (button) {
          button.classList.remove('bg-white', 'border-slate-200', 'text-slate-600', 'shadow-sm');
          button.classList.add('bg-primary-600', 'border-primary-600', 'text-white', 'shadow-md');
        }
      } else {
        // Close sidebar
        sidebar.style.width = '0';
        if (button) {
          button.classList.remove('bg-primary-600', 'border-primary-600', 'text-white', 'shadow-md');
          button.classList.add('bg-white', 'border-slate-200', 'text-slate-600', 'shadow-sm');
        }
      }
    });

    // Toggle sidebar acts as master toggle for comment mode
    function toggleCommentsSidebar() {
      if (window.widgetInstance) {
        const sidebar = document.getElementById('commentsSidebar');
        const isOpen = sidebar.style.width === '320px';
        
        if (isOpen) {
          window.widgetInstance.hide();
        } else {
          window.widgetInstance.show();
        }
      }
    }

    // Listen for comment changes (add/delete/update)
    window.addEventListener('comment-widget-event', (e) => {
      if (e.detail && e.detail.type === 'COMMENTS_CHANGED') {
        // Update sidebar if open
        const sidebar = document.getElementById('commentsSidebar');
        if (sidebar.style.width === '320px') {
           renderCommentsSidebar();
        }
        // Update count always
        updateCommentsCount();
      }
    });
  </script>
</body>
</html>
